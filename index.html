<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Transaksi Stokis GMRJ (Cloud Login)</title>
<style>
:root {
/* Palet Warna Hijau Profesional */
--color-primary: #065f46;
--color-primary-dark: #064e3b;
--color-primary-light: #10b981;
--color-secondary: #d1fae5;
--color-bg: #f0fdf4;
--color-surface: #ffffff;
--color-text: #1f2937;
--color-text-light: #6b7280;
--color-border: #e5e7eb;
--color-success: #059669;
--color-warning: #d97706;
--color-error: #dc2626;

/* Spacing & Layout */
--spacing-4: 4px;
--spacing-8: 8px;
--spacing-12: 12px;
--spacing-16: 16px;
--spacing-20: 20px;
--spacing-24: 24px;
--spacing-32: 32px;
--radius: 12px;

/* Shadows */
--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

body {
background-color: var(--color-bg);
color: var(--color-text);
line-height: 1.5;
-webkit-font-smoothing: antialiased;
}

.container {
display: none;
grid-template-columns: 260px 1fr;
min-height: 100vh;
}

/* Sidebar */
.sidebar {
background: linear-gradient(180deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
color: white;
padding: var(--spacing-24);
overflow-y: auto;
position: sticky;
top: 0;
height: 100vh;
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
z-index: 1000;
box-shadow: var(--shadow-lg);
}

.sidebar-title {
font-size: 20px;
font-weight: 700;
margin-bottom: var(--spacing-24);
padding-bottom: var(--spacing-16);
border-bottom: 1px solid rgba(255,255,255,0.15);
display: flex;
justify-content: space-between;
align-items: center;
letter-spacing: -0.5px;
}

.close-sidebar-btn {
background: none; border: none; color: rgba(255,255,255,0.8);
font-size: 24px; cursor: pointer; display: none; transition: color 0.2s;
}
.close-sidebar-btn:hover { color: white; }

.nav-menu { list-style: none; display: flex; flex-direction: column; gap: 4px; }
.nav-menu button {
width: 100%; padding: var(--spacing-12) var(--spacing-16);
background: none; border: none; color: rgba(255,255,255,0.8);
cursor: pointer; text-align: left; border-radius: var(--radius);
transition: all 0.2s; font-size: 14px; font-weight: 500;
display: flex; align-items: center; gap: 10px;
}
.nav-menu button:hover { background: rgba(255,255,255,0.1); color: white; }
.nav-menu button.active { background: var(--color-surface); color: var(--color-primary); font-weight: 700; box-shadow: var(--shadow-md); }

.main-content { padding: var(--spacing-24); overflow-y: auto; width: 100%; }

.mobile-menu-btn {
display: none; background: none; border: none; font-size: 28px;
color: var(--color-primary); cursor: pointer; margin-right: var(--spacing-8);
}

.header { margin-bottom: var(--spacing-32); display: flex; flex-direction: column; }
.header-top { display: flex; align-items: center; }
.header h1 { font-size: 32px; font-weight: 800; color: var(--color-primary-dark); margin-bottom: 4px; letter-spacing: -1px; }
.header p { color: var(--color-text-light); font-size: 16px; }

/* Cards */
.card {
background: var(--color-surface);
border-radius: var(--radius);
padding: var(--spacing-24);
margin-bottom: var(--spacing-24);
border: 1px solid var(--color-border);
box-shadow: var(--shadow-sm);
transition: box-shadow 0.3s ease;
}
.card:hover { box-shadow: var(--shadow-md); }
.card h3 { margin-bottom: var(--spacing-20); color: var(--color-text); font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }

/* Stats Grid */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--spacing-24); margin-bottom: var(--spacing-32); }
.stat-box {
background: var(--color-surface); padding: var(--spacing-24); border-radius: var(--radius);
border: 1px solid var(--color-border); box-shadow: var(--shadow-sm);
border-left:5px solid var(--color-primary);
}
.stat-label { color: var(--color-text-light); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--spacing-8); }
.stat-value { font-size: 32px; font-weight: 800; color: var(--color-primary-dark); }

/* Tables */
.table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--color-border); }
table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: auto; }
#points-table { table-layout: fixed; }
#points-table th:nth-child(1) { width: 28%; text-align: left; }
#points-table td:nth-child(1) { text-align: left; }
#points-table th:not(:nth-child(1)), #points-table td:not(:nth-child(1)) { text-align: right; }

th {
background: #f8fafc; padding: var(--spacing-12) var(--spacing-16); text-align: left;
font-weight: 700; color: var(--color-text); border-bottom: 2px solid var(--color-border);
white-space: nowrap;
}
td { padding: var(--spacing-12) var(--spacing-16); border-bottom: 1px solid var(--color-border); vertical-align: middle; }
tbody tr:nth-child(even) { background-color: #fafbfc; }
tbody tr:hover { background-color: #f3f4f6; transition: background 0.2s; }

th.text-right, td.text-right { text-align: right; }
td.font-mono { font-family: 'Courier New', Courier, monospace; letter-spacing: -0.5px; }

tbody tr.total-row, tfoot tr {
background: var(--color-primary) !important; color: white !important;
font-weight: 700; border-top: 2px solid rgba(255,255,255,0.3) !important;
}
tbody tr.total-row td, tfoot tr td { border-bottom: none !important; padding: 16px; color: white; }

.form-group { margin-bottom: var(--spacing-20); }
label { display: block; margin-bottom: var(--spacing-8); font-weight: 600; color: var(--color-text); font-size: 14px; }
input, select, textarea {
width: 100%; padding: 10px 12px;
border: 1px solid #d1d5db; border-radius: 8px;
font-size: 14px; color: var(--color-text);
transition: all 0.2s; background: white;
}
table input[type="number"] {
padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px;
width: 90px; text-align: right; font-weight: 600;
}
input:focus, select:focus, textarea:focus {
outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(6, 95, 70, 0.1);
}
input:disabled { background-color: #f3f4f6; cursor: not-allowed; color: #9ca3af; }

.date-filter-group {
display: flex;
align-items: center;
gap: 10px;
background: #f0fdf4;
padding: 10px;
border-radius: 8px;
border: 1px solid var(--color-border);
margin-bottom: 16px;
flex-wrap: wrap;
}
.date-filter-group label { margin-bottom: 0; white-space: nowrap; }
.date-filter-group input { width: auto; }

.btn {
padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer;
font-weight: 600; font-size: 14px; transition: all 0.2s;
display: inline-flex; align-items: center; gap: 8px; justify-content: center;
text-decoration: none;
}
.btn-primary { background: var(--color-primary); color: white; box-shadow: var(--shadow-sm); }
.btn-primary:hover { background: var(--color-primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
.btn-secondary { background: white; border: 1px solid #d1d5db; color: var(--color-text); }
.btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; }
.btn-danger { background: #fef2f2; color: var(--color-error); border: 1px solid #fecaca; }
.btn-danger:hover { background: #fee2e2; border-color: #fca5a5; }
.btn-success { background: #ecfdf5; color: var(--color-success); border: 1px solid #a7f3d0; }
.btn-success:hover { background: #d1fae5; border-color: #6ee7b7; }
.btn-wa { background: #25D366; color: white; }
.btn-wa:hover { background: #128C7E; }
.btn-small { padding: 6px 10px; font-size: 12px; border-radius: 6px; }

.toast-container {
position: fixed; bottom: 20px; right: 20px; z-index: 9999;
display: flex; flex-direction: column; gap: 10px;
}
.toast {
background: #333; color: white; padding: 12px 20px; border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px;
animation: slideInRight 0.3s ease-out forwards; display: flex; align-items: center; gap: 10px;
}
.toast.success { border-left: 4px solid var(--color-success); background: white; color: var(--color-text); }
.toast.error { border-left: 4px solid var(--color-error); background: white; color: var(--color-text); }

@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

.pagination { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; align-items: center; }
.pagination button {
padding: 6px 12px; border: 1px solid var(--color-border); background: white;
border-radius: 6px; cursor: pointer; font-size: 13px;
}
.pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
.pagination button:hover:not(:disabled) { background: #f3f4f6; }
.pagination span { font-size: 13px; color: var(--color-text-light); }

.modal {
display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
align-items: center; justify-content: center; z-index: 2000;
animation: fadeIn 0.2s ease-out;
}
.modal.active { display: flex; }
.modal-content {
background: var(--color-surface); padding: var(--spacing-24); border-radius: var(--radius);
width: 95%; max-width: 600px;
max-height: 90vh; overflow-y: auto;
box-shadow: var(--shadow-lg); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
.modal-header {
display: flex; justify-content: space-between; align-items: center;
margin-bottom: var(--spacing-20); padding-bottom: var(--spacing-16);
border-bottom: 1px solid var(--color-border);
}
.modal-header h2 { font-size: 20px; font-weight: 700; color: var(--color-primary-dark); }
.close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-light); transition: color 0.2s; }
.close-btn:hover { color: var(--color-error); }

.cart-row {
display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px;
align-items: center;
padding-bottom: 8px; border-bottom: 1px dashed #e5e7eb;
}

.info-container { display: flex; flex-direction: column; gap: 20px; }
.info-card {
background: white; border: 1px solid var(--color-border); border-radius: var(--radius);
padding: 20px; box-shadow: var(--shadow-sm);
}
.info-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
.info-title { font-weight: 700; color: var(--color-primary-dark); }
.info-date { font-size: 12px; color: var(--color-text-light); }
.info-body { font-size: 14px; color: var(--color-text); margin-bottom: 15px; line-height: 1.6; white-space: pre-wrap; }

.level-0 { color: #c0152f; font-weight: 700; }
.level-1 { color: #e6814d; font-weight: 600; }
.level-2 { color: #208090; font-weight: 600; }
.level-3 { color: #2d7ab6; font-weight: 600; }
.level-4 { color: #6b21a8; font-weight: 600; }
.level-5 { color: #059669; font-weight: 600; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.badge-success { background: rgba(5, 150, 105, 0.2); color: #059669; border: 1px solid #a7f3d0; }
.badge-inactive { background: #e5e7eb; color: #6b7280; border: 1px solid #e5e7eb; }
.badge-blue { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-16); }
.report-accordion {
margin-bottom: var(--spacing-24); border: 1px solid var(--color-border);
border-radius: var(--radius); background: var(--color-surface);
box-shadow: var(--shadow-sm); overflow: hidden;
}
.report-header {
display: flex; justify-content: space-between; align-items: center;
padding: var(--spacing-16) var(--spacing-24); background: #f8fafc;
cursor: pointer; user-select: none; transition: background 0.2s;
flex-wrap: nowrap;
}
.report-header:hover { background: #f1f5f9; }
.report-header h3 { margin: 0; font-size: 16px; color: var(--color-text); display: flex; align-items: center; gap: var(--spacing-8); font-weight: 600; }
.report-header h3::before {
content: '+'; display: inline-block; font-size: 20px; font-weight: 700;
color: var(--color-primary); transition: transform 0.3s; width: 20px; text-align: center;
}
.report-accordion.active .report-header h3::before { transform: rotate(45deg); }
.report-body { display: none; padding: var(--spacing-24); border-top: 1px solid var(--color-border); }
.report-accordion.active .report-body { display: block; animation: slideDown 0.3s ease-out; }

.page-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-24); flex-wrap: wrap; gap: 10px; }
.toolbar-actions { display: flex; gap: var(--spacing-8); }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 300px; margin: 0 auto; }
.calc-display { background: #1f2937; color: white; font-family: 'Courier New', monospace; font-size: 24px; text-align: right; padding: 15px; border-radius: 8px; margin-bottom: 15px; min-height: 60px; word-break: break-all; }
.calc-btn { padding: 15px; font-size: 18px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: background 0.2s; text-align: center; }
.calc-btn:hover { background: #e5e7eb; }
.calc-btn.op { background: #d1fae5; color: #065f46; }
.calc-btn.op:hover { background: #a7f3d0; }
.calc-btn.equal { background: var(--color-primary); color: white; }
.calc-btn.equal:hover { background: var(--color-primary-dark); }
.calc-btn.clear { background: var(--color-error); color: white; }
.calc-btn.clear:hover { background: #b91c1c; }

#login-screen, #register-screen {
position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
display: flex; justify-content: center; align-items: center; z-index: 9999;
}
.login-card {
background: white; padding: 48px; border-radius: 16px;
box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center;
}
.login-card h2 { margin-bottom: var(--spacing-24); color: var(--color-primary-dark); font-size: 24px; }
.login-card input { margin-bottom: var(--spacing-16); padding: 12px; }
.login-btn { width: 100%; padding: 14px; font-size: 16px; letter-spacing: 0.5px; }

@media print {
.no-print, .sidebar, .header, .mobile-menu-btn, .nav-menu, .modal, .form-group, .btn, .pagination, .date-filter-group { display: none !important; }
body, .container, .main-content { height: auto !important; overflow: visible !important; display: block !important; padding: 0 !important; margin: 0 !important; position: static !important; background: white !important; color: black !important; }
.tab-content { display: none !important; }
.print-header { display: block !important; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; text-align: center; }
.print-header h2 { margin: 0; font-size: 20px; text-transform: uppercase; }
body.printing-transactions #transactions { display: block !important; }
body.printing-points #points { display: block !important; }
body.printing-members #members { display: block !important; }
body.printing-info #information { display: block !important; }
#reports { display: block !important; }
body.printing-report-overview #reports { display: block !important; }
body.printing-report-overview #overview .report-body { display: block !important; }
body.printing-report-memberprod #reports { display: block !important; }
body.printing-report-prodmember #reports { display: block !important; }
body.printing-report-ranking #reports { display: block !important; }

body.printing-transactions .card, body.printing-points .card, body.printing-members .card, body.printing-info .info-card,
body.printing-report-overview .card, body.printing-report-memberprod .card, body.printing-report-prodmember .card {
border: none !important; box-shadow: none !important; padding: 0 !important; }
}

@media (max-width: 768px) {
.container { grid-template-columns: 1fr; }
.sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; transform: translateX(-100%); }
.sidebar.active { transform: translateX(0); }
.close-sidebar-btn { display: block; }
.mobile-menu-btn { display: block; }
.main-content { padding: var(--spacing-16); }
.form-row { grid-template-columns: 1fr; }
.header h1 { font-size: 24px; }
.card { padding: var(--spacing-16); }
.page-toolbar { flex-direction: column; gap: 10px; align-items: flex-start; }
.btn { width: 100%; justify-content: center; }
.stats-grid { grid-template-columns: 1fr; }
.cart-row { grid-template-columns: 1fr; gap: 8px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb; }
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, setDoc, doc, getDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyA7i0bGhjKHZ788Ir7xTDFM0LXAevnWKsI",
authDomain: "sistem-stokis-gmrj.firebaseapp.com",
projectId: "sistem-stokis-gmrj",
storageBucket: "sistem-stokis-gmrj.firebasestorage.app",
messagingSenderId: "288883517168",
appId: "1:288883517168:web:d5cdd864aa944205df8435",
measurementId: "G-12KELDXJ1J"
};

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);
window.firestoreDB = db;

window.firestoreDoc = doc;
window.firestoreGetDoc = getDoc;
window.firestoreSetDoc = setDoc;
window.firestoreOnSnapshot = onSnapshot;
window.firestoreCollection = collection;
window.firestoreQuery = query;
window.firestoreOrderBy = orderBy;

window.getUserDocRef = function(username) { return window.firestoreDoc(db, 'stokisDatas', (username || '').toLowerCase()); };
window.loadUserDataFromFirestore = async function(username) {
const snap = await window.firestoreGetDoc(window.getUserDocRef(username));
return snap.exists() ? snap.data() : null;
};
window.saveUserDataToFirestore = async function(username, data) {
await window.firestoreSetDoc(window.getUserDocRef(username), data, { merge: true });
};
window.listenUserDataRealtime = function(username, callback) {
return window.firestoreOnSnapshot(window.getUserDocRef(username), (snap) => {
if(snap.exists()) callback(snap.data());
});
};
console.log("Firestore ready.");

const INFO_CONTAINER_ID = 'info-list';

window.loadAdminAnnouncements = function() {
    const container = document.getElementById(INFO_CONTAINER_ID);
    if (!container) {
        console.warn("Container info tidak ditemukan.");
        return;
    }

    container.innerHTML = '<div class="info-card"><p style="text-align:center; color:#94a3b8; font-size:12px;">Memuat pengumuman...</p></div>';

    const COLLECTION_ANNOUNCEMENTS = 'adminAnnouncements';
    const q = window.firestoreQuery(window.firestoreCollection(db, COLLECTION_ANNOUNCEMENTS), window.firestoreOrderBy('createdAt', 'desc'));

    window.firestoreOnSnapshot(q, (snapshot) => {
        if (snapshot.empty) {
            container.innerHTML = '<div class="info-card"><p style="text-align:center; color:#cbd5e1; font-size:12px; padding:20px; border:1px dashed #e2e8f0; border-radius:8px;">Tidak ada pengumuman terbaru.</p></div>';
            return;
        }

        let html = '';
        snapshot.forEach(docSnapshot => {
            const a = docSnapshot.data();
            let fileHtml = '';
            if (a.fileUrl && a.fileName) {
                fileHtml = `<div style="margin-top:10px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:6px; padding:8px; display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; align-items:center; gap:8px;"><span style="font-size:18px;">üìé</span><span style="font-size:12px; font-weight:bold; color:#0369a1;">${a.fileName}</span></div><a href="${a.fileUrl}" target="_blank" style="font-size:11px; background:#0369a1; color:white; padding:4px 8px; border-radius:4px; text-decoration:none;">Download</a></div>`;
            }

            html += `<div class="info-card" style="background:#fffbeb; border:1px solid #fcd34d;"><div style="display:flex; justify-content:space-between; margin-bottom:8px;"><h4 style="margin:0; font-size:15px; font-weight:700; color:#92400e;">${a.title}</h4><span style="font-size:11px; color:#92400e;">${a.createdAt ? new Date(a.createdAt.toDate()).toLocaleDateString() : '-'}</span></div><div style="font-size:13px; color:#374151; white-space: pre-wrap; line-height:1.5;">${a.content}</div>${fileHtml}</div>`;
        });

        container.innerHTML = html;
    }, (error) => {
        console.error("Gagal memuat pengumuman:", error);
        container.innerHTML = '<div class="info-card"><p style="color:red; font-size:12px;">Gagal memuat informasi.</p></div>';
    });
};

</script>

</head>
<body>

<div id="toast-container" class="toast-container"></div>

<div id="login-screen">
<div class="login-card">
<h2>üîê Login Sistem Stokis</h2>
<form onsubmit="checkLogin(event)">
<div class="form-group" style="text-align: left;"><label>Username</label><input type="text" id="loginUsername" required placeholder="Masukkan Username"></div>
<div class="form-group" style="text-align: left;"><label>Password</label><input type="password" id="loginPassword" required placeholder="Masukkan Password"></div>
<button type="submit" class="btn btn-primary login-btn">Masuk Aplikasi</button>
</form>
<div style="margin-top: 20px;"><button class="btn btn-secondary" style="width: 100%;" onclick="toggleScreen('register')">üìù Daftar Akun Baru</button></div>
</div>
</div>

<div id="register-screen" style="display: none;">
<div class="login-card">
<h2>üìù Registrasi User Baru</h2>
<form onsubmit="handleRegister(event)">
<div class="form-group" style="text-align: left;"><label>Username</label><input type="text" id="regUsername" required></div>
<div class="form-group" style="text-align: left;"><label>Password</label><input type="password" id="regPassword" required></div>
<button type="submit" class="btn btn-primary login-btn">Daftar</button>
</form>
<div style="margin-top: 20px;"><button class="btn btn-secondary" style="width: 100%;" onclick="toggleScreen('login')">üîô Kembali ke Login</button></div>
</div>
</div>

<div class="container">
<div class="sidebar no-print" id="sidebar">
<div class="sidebar-title">
<div style="display:flex; align-items:center; gap: 12px;"><span style="font-weight: 700; font-size: 20px;">Stokis GMRJ</span></div>
<button class="close-sidebar-btn" onclick="toggleSidebar()">&times;</button>
</div>
<ul class="nav-menu">
<li><button class="nav-btn" data-tab="profile" onclick="closeSidebarMobile()">üë§ Profil</button></li>
<li><button class="nav-btn active" data-tab="dashboard" onclick="closeSidebarMobile()">üìä Dashboard</button></li>
<li><button class="nav-btn" data-tab="products" onclick="closeSidebarMobile()">üì¶ Produk</button></li>
<li><button class="nav-btn" data-tab="members" onclick="closeSidebarMobile()">üë• Member</button></li>
<li><button class="nav-btn" data-tab="transactions" onclick="closeSidebarMobile()">üìà Transaksi</button></li>
<li><button class="nav-btn" data-tab="points" onclick="closeSidebarMobile()">üìä Poin Member</button></li>
<li><button class="nav-btn" data-tab="reports" onclick="closeSidebarMobile()">üìã Laporan</button></li>
<li><button class="nav-btn" data-tab="information" onclick="closeSidebarMobile()">üîî Informasi</button></li>
<li><button class="nav-btn" data-tab="calculator" onclick="closeSidebarMobile()">üßÆ Kalkulator</button></li>
<li><button class="nav-btn" data-tab="settings" onclick="closeSidebarMobile()">‚öôÔ∏è Pengaturan</button></li>
</ul>
</div>

<div class="main-content">
<div class="header no-print">
<div class="header-top">
<button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
<div>
<h1>Data Transaksi Stokis</h1>
<p>Dashboard Manajemen Stokis</p>
</div>
</div>
</div>

<div id="dashboard" class="tab-content active">
<div class="stats-grid">
<div class="stat-box"><div class="stat-label">Total Member</div><div class="stat-value" id="total-members">0</div></div>
<div class="stat-box"><div class="stat-label">Total Produk</div><div class="stat-value" id="total-products">0</div></div>
<div class="stat-box"><div class="stat-label">Total Transaksi</div><div class="stat-value" id="total-transactions">0</div></div>
<div class="stat-box"><div class="stat-label">Total Poin</div><div class="stat-value" id="total-points">0</div></div>
</div>

<div class="card">
<h3>üìä Transaksi Penjualan Terbaru</h3>
<div class="table-wrapper">
<table id="recent-transactions">
<thead><tr><th>Tanggal</th><th>Member</th><th>Produk</th><th class="text-right">Jumlah</th><th class="text-right">Total Poin</th></tr></thead>
<tbody><tr><td colspan="5" style="text-align: center; color: #9ca3af;">Belum ada data</td></tr></tbody>
</table>
</div>
</div>
</div>

<div id="profile" class="tab-content" style="display: none;">
<div class="card">
<h3>üë§ Profil</h3>
<form onsubmit="saveProfile(event)">
<div class="form-group"><label>Nama Koordinat</label><input type="text" id="profileNamaKoordinat"></div>
<div class="form-group"><label>Kode Koordinat</label><input type="text" id="profileKodeKoordinat" maxlength="5" style="text-transform: uppercase;"></div>
<div class="form-group"><label>Nama Stokis</label><input type="text" id="profileNamaStokis"></div>
<div class="form-group"><label>No. Whatsapp</label><input type="text" id="profileWaNumber"></div>
<div class="form-group"><label>Alamat Stokis</label><textarea id="profileAlamat" rows="3"></textarea></div>
<button type="submit" class="btn btn-primary" style="width: 100%;">üíæ Simpan Profil</button>
</form>
</div>
</div>

<div id="products" class="tab-content" style="display: none;">
<div class="card">
<div class="page-toolbar">
<h3 style="margin: 0;">Daftar Produk</h3>
<button class="btn btn-primary" onclick="openAddProductModal()">+ Tambah Produk</button>
</div>
<div class="table-wrapper">
<table id="products-table">
<thead><tr><th>Nama Produk</th><th>Poin/Satuan</th><th>Stok Akhir</th><th class="text-right">Total Poin</th><th>Aksi</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>

<div id="members" class="tab-content" style="display: none;">
<div class="card">
<div class="page-toolbar">
<h3 style="margin: 0;">Daftar Member</h3>
<div class="toolbar-actions">
<button class="btn btn-primary" onclick="openAddMemberModal()">+ Tambah Member</button>
<button class="btn btn-wa" onclick="openBroadcastModal()">üì¢ Broadcast WA</button>
</div>
</div>
<div class="table-wrapper">
<table id="members-table">
<thead><tr><th>ID</th><th>Nama</th><th>Upline</th><th>Koordinat</th><th class="text-right">Total Poin</th><th>Status</th><th>Kontak WA</th><th>Aksi</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>

<div id="transactions" class="tab-content" style="display: none;">
<div class="card">
<div class="page-toolbar">
<h3 style="margin: 0; color: var(--color-primary-dark);">üì¶ Riwayat Pembelian Stokis</h3>
<div class="toolbar-actions">
<button class="btn btn-success" onclick="openStockPurchaseModal()">+ Input Pembelian Stok</button>
</div>
</div>
<p style="font-size: 13px; color: var(--color-text-light); margin-bottom: 15px;">Transaksi ini akan menambah stok produk yang tersedia.</p>
<div class="date-filter-group no-print">
<label>Filter Produk:</label>
<select id="stockFilterProduct" style="width: auto; min-width: 150px;">
<option value="">-- Semua Produk --</option>
</select>
<span style="width: 1px; height: 20px; background: #e5e7eb; margin: 0 5px;"></span>
<label>Periode:</label>
<input type="date" id="stockFilterStart">
<span>s/d</span>
<input type="date" id="stockFilterEnd">
<button class="btn btn-small btn-primary" onclick="applyStockFilter()">Terapkan</button>
<button class="btn btn-small btn-secondary" onclick="resetStockFilter()">Reset</button>
</div>
<div class="table-wrapper">
<table id="stock-history-table">
<thead><tr><th>No</th><th>Kode</th><th>Tanggal</th><th>Produk</th><th class="text-right">Jumlah Beli</th><th class="text-right">Total Poin</th><th class="no-print">Aksi</th></tr></thead>
<tbody></tbody>
</table>
</div>
<div class="pagination" id="stock-pagination"></div>
</div>

<div class="card">
<div class="page-toolbar">
<h3 style="margin: 0;">Input Penjualan ke Member</h3>
<div class="toolbar-actions"><button class="btn btn-primary" onclick="openAddTransactionModal()">+ Penjualan Baru</button></div>
</div>
<div class="date-filter-group no-print">
<label>Filter Tanggal:</label>
<input type="date" id="filterDateStart">
<span>s/d</span>
<input type="date" id="filterDateEnd">
<button class="btn btn-small btn-primary" onclick="applyTransactionFilter()">Terapkan</button>
<button class="btn btn-small btn-secondary" onclick="resetTransactionFilter()">Reset</button>
</div>
<div class="table-wrapper">
<table id="transactions-table">
<thead><tr><th>No</th><th>Kode Transaksi</th><th>Tanggal</th><th>Member</th><th>Produk</th><th class="text-right">Jml Jual</th><th class="text-right">Total Poin</th><th class="no-print">Aksi</th></tr></thead>
<tbody></tbody>
</table>
</div>
<div class="pagination" id="trans-pagination"></div>
</div>
</div>

<div id="points" class="tab-content" style="display: none;">
<div class="card">
<div class="date-filter-group no-print" style="background:white; border:none; padding:0; margin-bottom:10px;">
<label>Cari Member:</label>
<input type="text" id="pointsSearch" placeholder="Ketik nama member..." oninput="searchPoints()">
</div>
<div class="table-wrapper"><table id="points-table"><thead><tr><th>Member</th><th>L0</th><th>L1</th><th>L2</th><th>L3</th><th>L4</th><th>L5</th><th class="text-right">Total</th></tr></thead><tbody></tbody></table></div>
<div class="pagination" id="points-pagination"></div>
</div>
</div>

<div id="reports" class="tab-content" style="display: none;">
<h2 style="margin-bottom: 20px;">Laporan & Analisis</h2>
<div class="report-accordion active" id="acc-overview">
<div class="report-header" onclick="toggleReportSection('overview')">
<h3>üìä Ringkasan (Beli vs Jual)</h3>
<div class="toolbar-actions">
<button class="btn btn-secondary no-print" onclick="event.stopPropagation(); printReport('overview')">üñ®Ô∏è Cetak</button>
</div>
</div>
<div id="overview" class="report-body">
<div class="date-filter-group no-print">
<label>Periode:</label>
<input type="date" id="repFilterStart">
<span>s/d</span>
<input type="date" id="repFilterEnd">
<button class="btn btn-small btn-primary" onclick="app.renderReports()">Terapkan</button>
</div>
<div class="table-wrapper"><table id="report-table"><thead><tr><th>Produk</th><th>Poin</th><th class="text-right">Beli (Stok)</th><th class="text-right">Poin Beli</th><th class="text-right">Jual (Keluar)</th><th class="text-right">Poin Jual</th></tr></thead><tbody></tbody><tfoot><tr><td colspan="2"><strong>AKUMULASI</strong></td><td class="text-right" id="report-sum-beli">0</td><td class="text-right" id="report-sum-point-beli">0.00</td><td class="text-right" id="report-sum-jual">0</td><td class="text-right" id="report-sum-point-jual">0.00</td></tr></tfoot></table></div>
</div>
</div>
<div class="report-accordion" id="acc-memberprod">
<div class="report-header" onclick="toggleReportSection('memberprod')">
<h3>üë• Laporan Pembelian Member per Produk</h3>
<div class="toolbar-actions"><button class="btn btn-secondary no-print" onclick="event.stopPropagation(); printReport('memberprod')">üñ®Ô∏è Cetak</button></div>
</div>
<div id="memberprod" class="report-body">
<div class="date-filter-group no-print">
<label>Periode:</label>
<input type="date" id="repMemProdStart">
<span>s/d</span>
<input type="date" id="repMemProdEnd">
<button class="btn btn-small btn-primary" onclick="renderReportMemberProduk()">Terapkan</button>
</div>
<div class="form-group" style="max-width: 300px;"><label>Pilih Produk:</label><select id="report-product-select"><option value="">-- Semua Produk --</option></select></div>
<div class="table-wrapper"><table id="member-product-table"><thead><tr><th>Nama Member</th><th>Produk</th><th class="text-right">Qty</th><th class="text-right">Poin</th></tr></thead><tbody></tbody></table></div>
</div>
</div>
<div class="report-accordion" id="acc-prodmember">
<div class="report-header" onclick="toggleReportSection('prodmember')">
<h3>üõí Laporan Pembelian Produk per Member</h3>
<div class="toolbar-actions"><button class="btn btn-secondary no-print" onclick="event.stopPropagation(); printReport('prodmember')">üñ®Ô∏è Cetak</button></div>
</div>
<div id="prodmember" class="report-body">
<div class="date-filter-group no-print">
<label>Periode:</label>
<input type="date" id="repProdMemStart">
<span>s/d</span>
<input type="date" id="repProdMemEnd">
<button class="btn btn-small btn-primary" onclick="renderReportProdMember()">Terapkan</button>
</div>
<div class="form-group" style="max-width: 300px;"><label>Pilih Member:</label><select id="report-member-select"><option value="">-- Pilih Member --</option></select></div>
<div class="table-wrapper"><table id="product-member-table"><thead><tr><th>Nama Produk</th><th class="text-right">Total Terjual</th><th class="text-right">Total Poin</th></tr></thead><tbody></tbody></table></div>
</div>
</div>
<div class="report-accordion" id="acc-ranking">
<div class="report-header" onclick="toggleReportSection('ranking')">
<h3>üèÜ Ranking Poin</h3>
<div class="toolbar-actions"><button class="btn btn-secondary no-print" onclick="event.stopPropagation(); printReport('ranking')">üñ®Ô∏è Cetak</button></div>
</div>
<div id="ranking" class="report-body"><div class="table-wrapper"><table id="ranking-table"><thead><tr><th>Ranking</th><th>ID</th><th>Nama</th><th class="text-right">Total Poin</th><th>Upline</th></tr></thead><tbody></tbody></table></div></div>
</div>
</div>

<div id="information" class="tab-content" style="display: none;">
<div class="card">
<h3>üîî Papan Informasi Admin</h3>
<p style="margin-bottom: 20px; color: var(--color-text-light);">Berikut adalah pengumuman dan dokumen resmi dari Admin Pusat.</p>
<div id="info-list" class="info-container">
<!-- Pengumuman akan dimuat di sini -->
</div>
</div>
</div>

<div id="calculator" class="tab-content" style="display: none;">
<div class="card"><h3 style="text-align: center;">üßÆ Kalkulator</h3>
<div class="calculator-wrapper" style="max-width: 350px; margin: 0 auto;">
<div class="calc-display" id="calcDisplay">0</div>
<div class="calculator-grid">
<button class="calc-btn clear" onclick="calcClear()">AC</button>
<button class="calc-btn" onclick="calcInput('(');">(</button>
<button class="calc-btn" onclick="calcInput(')');">)</button>
<button class="calc-btn op" onclick="calcInput('/');">√∑</button>
<button class="calc-btn" onclick="calcInput('7');">7</button>
<button class="calc-btn" onclick="calcInput('8');">8</button>
<button class="calc-btn" onclick="calcInput('9');">9</button>
<button class="calc-btn op" onclick="calcInput('*');">√ó</button>
<button class="calc-btn" onclick="calcInput('4');">4</button>
<button class="calc-btn" onclick="calcInput('5');">5</button>
<button class="calc-btn" onclick="calcInput('6');">6</button>
<button class="calc-btn op" onclick="calcInput('-');">-</button>
<button class="calc-btn" onclick="calcInput('1');">1</button>
<button class="calc-btn" onclick="calcInput('2');">2</button>
<button class="calc-btn" onclick="calcInput('3');">3</button>
<button class="calc-btn op" onclick="calcInput('+');">+</button>
<button class="calc-btn" onclick="calcInput('0');">0</button>
<button class="calc-btn" onclick="calcInput('.');">.</button>
<button class="calc-btn equal" onclick="calcCalculate();">=</button>
<button class="calc-btn clear" onclick="calcDelete();"><span style="font-size:16px;">üîô</span></button>
</div>
</div>
</div>
</div>

<div id="settings" class="tab-content" style="display: none;">
<div class="card">
<h3>‚öôÔ∏è Pengaturan & Data</h3>
<div class="backup-section" style="display: grid; gap: 20px; padding: 20px; background: #f0fdf4; border-radius: 12px; border: 1px dashed var(--color-primary);">
<div><h4>üìã Format Pesan Otomatis WA</h4><p style="font-size: 13px; color: var(--color-text-light); margin-bottom: 8px;">Template pesan saat kirim WA ke member. Gunakan <code>[Nama]</code> untuk nama member.</p><textarea id="profileWaAutoMsg" rows="3"></textarea><button class="btn btn-primary" style="margin-top: 10px; width: 100%;" onclick="saveWaAutoMsg()">üíæ Simpan Pesan</button></div>
<hr style="border: 0; border-top: 1px solid #d1fae5;">
<div><h4>üíæ Backup Database</h4><button class="btn btn-primary" onclick="exportData()">‚¨áÔ∏è Download Backup</button></div>
<hr style="border: 0; border-top: 1px solid #d1fae5;">
<div><h4>‚òÅÔ∏è Restore Database</h4><input type="file" id="importFile" accept=".json" style="margin-bottom: 8px;"><button class="btn btn-warning" onclick="importData()">‚¨ÜÔ∏è Restore Data</button></div>
<hr style="border: 0; border-top: 1px solid #d1fae5;">
<div><h4>‚ö†Ô∏è Zona Bahaya</h4><button class="btn btn-danger" onclick="resetData()">üóëÔ∏è Reset Semua Data</button></div>
<hr style="border: 0; border-top: 1px solid #d1fae5;">
<div style="text-align: center;"><button class="btn btn-danger" onclick="doLogout()">üö™ Logout</button></div>
</div>
</div>
</div>

<div id="productModal" class="modal">
<div class="modal-content">
<div class="modal-header"><h2 id="productModalTitle">Tambah Produk</h2><button class="close-btn" onclick="closeModal('productModal')">&times;</button></div>
<form onsubmit="saveProduct(event)">
<input type="hidden" id="productCode">
<div class="form-group"><label>Nama Produk</label><input type="text" id="productName" required></div>
<div class="form-group"><label>Poin Patokan</label><input type="number" id="productPoint" step="0.01"></div>
<div class="form-group" id="groupInitStock"><label>Stok Awal (Opsional)</label><input type="number" id="productInitStock" min="0" value="0"></div>
<button type="submit" class="btn btn-primary" style="width: 100%;">Simpan Produk</button>
</form>
</div>
</div>

<div id="memberModal" class="modal">
<div class="modal-content">
<div class="modal-header"><h2 id="memberModalTitle">Tambah Member</h2><button class="close-btn" onclick="closeModal('memberModal')">&times;</button></div>
<form onsubmit="saveMember(event)">
<input type="hidden" id="memberEditMode" value="false">
<input type="hidden" id="memberOriginalId" value="">
<div class="form-row">
<div class="form-group"><label>ID Member</label><input type="text" id="memberId" required></div>
<div class="form-group"><label>Nama Member</label><input type="text" id="memberName" required></div>
</div>
<div class="form-row">
<div class="form-group"><label>Upline</label><select id="memberUpline"><option value="">-- Tidak Ada --</option></select></div>
<div class="form-group"><label>Koordinat</label><input type="text" id="memberKoordinat"></div>
</div>
<div class="form-group"><label>No. Whatsapp</label><input type="text" id="memberWaNumber" placeholder="628..."></div>
<div class="form-group"><label>Status</label><select id="memberStatus"><option value="aktif">Aktif</option><option value="tidak aktif">Tidak Aktif</option></select></div>
<button type="submit" class="btn btn-primary" style="width: 100%;">üíæ Simpan Member</button>
</form>
</div>
</div>

<div id="transactionModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="transModalTitle">Input Penjualan</h2>
<button class="close-btn" onclick="closeModal('transactionModal')">&times;</button>
</div>
<form onsubmit="saveTransaction(event)">
<input type="hidden" id="transEditId" value="">
<div class="form-group">
<label>Tanggal Transaksi</label>
<input type="date" id="transactionDate" required>
</div>
<div class="form-group">
<label>Member Pembeli</label>
<select id="transactionMember" required>
<option value="">-- Pilih Member --</option>
</select>
</div>
<div class="form-group">
<label>Daftar Produk</label>
<div id="cart-container"></div>
<button type="button" id="btnAddRow" class="btn btn-secondary btn-small" onclick="addTransactionRow()" style="margin-top:8px;">+ Tambah Produk Lagi</button>
</div>
<div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 16px; margin-bottom: 16px; border-radius: 8px;">
<div style="display: flex; justify-content: space-between; font-size: 14px;">
<span style="color: #64748b;">Estimasi Total Poin:</span>
<strong id="transactionTotalPointsPreview" style="color: var(--color-primary); font-size: 18px;">0</strong>
</div>
</div>
<button type="submit" class="btn btn-primary" style="width: 100%;">Simpan Transaksi</button>
</form>
</div>
</div>

<div id="stockPurchaseModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="stockModalTitle">üì• Input Pembelian Stokis</h2>
<button class="close-btn" onclick="closeModal('stockPurchaseModal')">&times;</button>
</div>
<form onsubmit="saveStockPurchase(event)">
<input type="hidden" id="stockEditId" value="">
<div class="form-group">
<label>Tanggal Pembelian</label>
<input type="date" id="purchaseDate" required>
</div>
<div class="form-group">
<label>Produk</label>
<select id="purchaseProduct" required>
<option value="">-- Pilih Produk --</option>
</select>
</div>
<div class="form-group">
<label>Jumlah (Qty)</label>
<input type="number" id="purchaseQty" min="1" required placeholder="Masukkan jumlah barang masuk">
</div>
<div class="form-group">
<p style="font-size: 13px; color: var(--color-text-light); background: #f0fdf4; padding: 10px; border-radius: 6px;">Stok produk akan bertambah otomatis.</p>
</div>
<button type="submit" class="btn btn-success" style="width: 100%;">Simpan Pembelian Stok</button>
</form>
</div>
</div>

<div id="broadcastModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>üì¢ Broadcast WhatsApp</h2>
<button class="close-btn" onclick="closeModal('broadcastModal')">&times;</button>
</div>
<div class="form-group">
<p style="font-size:13px; color:var(--color-text-light); margin-bottom:10px;">Pastikan browser Anda <strong>MENGIZINKAN POP-UP</strong>. Jika tidak, pesan tidak akan terkirim.</p>
<label>Pesan Broadcast</label>
<textarea id="broadcastMessage" rows="4" placeholder="Tulis pesan disini..."></textarea>
</div>
<button class="btn btn-primary" style="width:100%;" onclick="executeBroadcast()">Kirim ke Semua Member</button>
</div>
</div>

<script>
function showToast(msg, type='success') {
const c = document.getElementById('toast-container');
const t = document.createElement('div'); t.className=`toast ${type}`;
t.innerHTML = `<span>${type==='success'?'‚úÖ':'‚ö†Ô∏è'}</span><span>${msg}</span>`;
c.appendChild(t);
setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 3000);
}

let currentUser = null;
let currentTransPage = 1;
let currentStockPage = 1;
const TRANS_PER_PAGE = 10;
const STOCK_PER_PAGE = 10;
let editingTransaction = false;
let currentPointsPage = 1;
const POINTS_PER_PAGE = 10;

const DEFAULT_PROFILE = {
namaKoordinat: '',
kodeKoordinat: '',
photoProfil: null,
namaStokis: '',
waNumber: '',
alamatStokis: '',
waAutoMsg: "Halo [Nama], ini pesan otomatis dari Stokis."
};

const app = {
products: [],
members: [],
transactions: [],
stockPurchases: [],
profile: null,
POINT_CONFIG: {
'Pendan Wulung': { levels: [0.70, 0.10, 0.08, 0.06, 0.04, 0.02], count: 6 },
'DEFAULT': { levels: [0.70, 0.20, 0.10], count: 3 }
},

init() {
this.setupEventListeners();
this.render();
const dashboard = document.getElementById('dashboard');
if(dashboard) { dashboard.classList.add('active'); dashboard.style.display='block'; }
this.loadProfileUI();
},

saveData() {
const data = { products: this.products, members: this.members, transactions: this.transactions, stockPurchases: this.stockPurchases, profile: this.profile };
if (window.saveUserDataToFirestore && currentUser) {
window.saveUserDataToFirestore(currentUser, data).then(() => showToast('Data disimpan')).catch(e => showToast('Gagal simpan', 'error'));
}
},

loadSampleData() {
const originalProductList = [
{ name: 'Pendan Wulung', point: 7.00 },
{ name: 'Pheromone', point: 0.05 }, { name: 'A Powder', point: 0.07 }, { name: 'B Powder', point: 0.07 }
];
this.products = originalProductList.map(p => ({ code: 'PROD_'+Date.now()+'_'+p.name.replace(/\s/g,''), name: p.name, point: p.point, pembelian: 0 }));
this.members = [
{ id: 'M001', name: 'Adi Kusumah', upline: null, koordinat: '', waNumber: '', status: 'aktif', totalPoints: 0 },
{ id: 'M002', name: 'Budi Santoso', upline: 'M001', koordinat: 'Bandung', waNumber: '628123456789', status: 'aktif', totalPoints: 0 }
];
this.transactions = [];
this.stockPurchases = [];
},

setupEventListeners() {
document.querySelectorAll('.nav-btn').forEach(btn => {
btn.addEventListener('click', (e) => {
document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
e.target.classList.add('active');
const tabName = e.target.dataset.tab;
document.querySelectorAll('.tab-content').forEach(t => { t.classList.remove('active'); t.style.display='none'; });
const target = document.getElementById(tabName);
if(target) { target.classList.add('active'); target.style.display='block'; }
if(tabName === 'points') { currentPointsPage=1; this.renderPoints(); }
if(tabName === 'reports') toggleReportSection('overview');
if(tabName === 'transactions') { currentTransPage=1; currentStockPage=1; this.renderTransactions(); this.renderStockHistory(); }
if(tabName === 'information') { if(window.loadAdminAnnouncements) window.loadAdminAnnouncements(); }
});
});
},

render() {
this.renderDashboard();
this.renderProducts();
this.renderMembers();
this.renderTransactions();
this.renderStockHistory();
this.updateModals();
this.renderReports();
},

loadProfileUI() {
const p = this.profile || DEFAULT_PROFILE;
document.getElementById('profileNamaKoordinat').value = p.namaKoordinat || '';
document.getElementById('profileKodeKoordinat').value = p.kodeKoordinat || '';
document.getElementById('profileNamaStokis').value = p.namaStokis || '';
document.getElementById('profileWaNumber').value = p.waNumber || '';
document.getElementById('profileAlamat').value = p.alamatStokis || '';
document.getElementById('profileWaAutoMsg').value = p.waAutoMsg || DEFAULT_PROFILE.waAutoMsg;
},

renderDashboard() {
const setText = (id,t) => { const el=document.getElementById(id); if(el) el.textContent=t; };
setText('total-members', this.members.length);
setText('total-products', this.products.length);
setText('total-transactions', this.transactions.length);
const totalPoints = this.transactions.reduce((sum,t) => sum + ((this.products.find(p=>p.code===t.productCode)?.point||0) * t.qty), 0);
setText('total-points', totalPoints.toFixed(2));

const tbody = document.querySelector('#recent-transactions tbody');
tbody.innerHTML = '';
const recent = [...this.transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

if(recent.length === 0) {
tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">Belum ada data</td></tr>';
} else {
recent.forEach(t => {
const m = this.members.find(x=>x.id===t.memberId); const p = this.products.find(x=>x.code===t.productCode);
tbody.innerHTML += `<tr><td>${t.date}</td><td>${m?.name||'Unknown'}</td><td>${p?.name||'Unknown'}</td><td class="text-right">${t.qty}</td><td class="text-right font-mono" style="color:var(--color-success);">${((p?.point||0)*t.qty).toFixed(2)}</td></tr>`;
});
}
},

renderProducts() {
const tbody = document.querySelector('#products-table tbody'); tbody.innerHTML='';
this.products.forEach(p => {
const tp = parseFloat(p.point) * parseInt(p.pembelian||0);
tbody.innerHTML += `<tr><td><strong>${p.name}</strong></td><td><span class="badge badge-blue">${p.point}</span></td>
<td style="color:var(--color-text-light);">${p.pembelian}</td>
<td class="text-right font-mono" style="color:var(--color-primary); font-weight:600;">${tp.toFixed(2)}</td>
<td>
<button class="btn btn-small btn-secondary" onclick="openEditProductModal('${p.code}')">‚úèÔ∏è</button>
<button class="btn btn-small btn-secondary" style="color:var(--color-error); border:1px solid #fecaca;" onclick="app.deleteProduct('${p.code}')">üóëÔ∏è</button>
</td></tr>`;
});
const repProdSelect = document.getElementById('report-product-select');
if(repProdSelect) {
const currentVal = repProdSelect.value;
repProdSelect.innerHTML = '<option value="">-- Semua Produk --</option>' + this.products.map(p => `<option value="${p.code}">${p.name}</option>`).join('');
repProdSelect.value = currentVal;
}
const purchaseProdSelect = document.getElementById('purchaseProduct');
if(purchaseProdSelect) {
const currentVal = purchaseProdSelect.value;
purchaseProdSelect.innerHTML = '<option value="">-- Pilih Produk --</option>' + this.products.map(p => `<option value="${p.code}">${p.name}</option>`).join('');
purchaseProdSelect.value = currentVal;
}
const stockFilterSelect = document.getElementById('stockFilterProduct');
if(stockFilterSelect) {
const currentVal = stockFilterSelect.value;
stockFilterSelect.innerHTML = '<option value="">-- Semua Produk --</option>' + this.products.map(p => `<option value="${p.code}">${p.name}</option>`).join('');
stockFilterSelect.value = currentVal;
}
},

renderMembers() {
this.calculateMemberPoints();

const tbody = document.querySelector('#members-table tbody'); tbody.innerHTML='';
const template = (this.profile || DEFAULT_PROFILE).waAutoMsg || "Halo [Nama]";
this.members.forEach(m => {
const upName = m.upline ? (this.members.find(u=>u.id===m.upline)?.name||'-') : '-';
let waBtn = '<span style="color:#9ca3af; font-size:12px;">-</span>';
if(m.waNumber) {
const finalMsg = template.replace('[Nama]', m.name);
const encodedMsg = encodeURIComponent(finalMsg);
waBtn = `<a href="https://wa.me/${m.waNumber}?text=${encodedMsg}" target="_blank" class="btn btn-small btn-wa">Hubungi WA</a>`;
}
tbody.innerHTML += `<tr><td><strong>${m.id}</strong></td><td>${m.name}</td><td>${upName}</td><td>${m.koordinat}</td>
<td class="text-right font-mono" style="color:var(--color-primary); font-weight:700;">${m.totalPoints.toFixed(2)}</td>
<td><span class="badge ${m.status==='aktif'?'badge-success':'badge-inactive'}">${m.status}</span></td>
<td>${waBtn}</td>
<td><button class="btn btn-small btn-secondary" onclick="editMember('${m.id}')">‚úèÔ∏è</button>
<button class="btn btn-small btn-secondary" style="color:var(--color-error); border:1px solid #fecaca;" onclick="deleteMember('${m.id}')">üóëÔ∏è</button></td></tr>`;
});
const upSelect = document.getElementById('memberUpline');
if(upSelect) {
const currentVal = upSelect.value;
upSelect.innerHTML = '<option value="">-- Tidak Ada --</option>' + this.members.map(m => `<option value="${m.id}">${m.name} (${m.id})</option>`).join('');
upSelect.value = currentVal;
}
const transSelect = document.getElementById('transactionMember');
if(transSelect) {
const currentVal = transSelect.value;
transSelect.innerHTML = '<option value="">-- Pilih Member --</option>' + this.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
transSelect.value = currentVal;
}
const repMemSelect = document.getElementById('report-member-select');
if(repMemSelect) {
const currentVal = repMemSelect.value;
repMemSelect.innerHTML = '<option value="">-- Pilih Member --</option>' + this.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
repMemSelect.value = currentVal;
}
},

renderTransactions() {
const tbody = document.querySelector('#transactions-table tbody'); tbody.innerHTML='';
let filtered = [...this.transactions];
const dStart = document.getElementById('filterDateStart').value;
const dEnd = document.getElementById('filterDateEnd').value;
if (dStart) filtered = filtered.filter(t => t.date >= dStart);
if (dEnd) filtered = filtered.filter(t => t.date <= dEnd);
filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
const totalPages = Math.ceil(filtered.length / TRANS_PER_PAGE);
if (currentTransPage > totalPages && totalPages > 0) currentTransPage = totalPages;
const start = (currentTransPage - 1) * TRANS_PER_PAGE;
const pageData = filtered.slice(start, start + TRANS_PER_PAGE);
if(pageData.length===0) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#9ca3af; padding:24px;">Tidak ada data</td></tr>';
else {
pageData.forEach((t, idx) => {
const m = this.members.find(x=>x.id===t.memberId); const p = this.products.find(x=>x.code===t.productCode);
tbody.innerHTML += `<tr><td>${start+idx+1}</td><td>${t.trxId}</td><td>${t.date}</td><td>${m?.name||'Unknown'}</td>
<td>${p?.name||'Unknown'}</td><td class="text-right">${t.qty}</td>
<td class="text-right font-mono" style="color:var(--color-success); font-weight:700;">${t.totalPoints.toFixed(2)}</td>
<td class="no-print">
<button class="btn btn-small btn-secondary" onclick="openEditTransaction('${t.id}')">‚úèÔ∏è</button>
<button class="btn btn-small btn-danger" onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button>
</td></tr>`;
});
}
const pag = document.getElementById('trans-pagination');
pag.innerHTML = `<span>Hal ${currentTransPage} dari ${totalPages||1}</span>
<button ${currentTransPage===1?'disabled':''} onclick="changeTransPage(-1)">Prev</button>
<button ${currentTransPage===totalPages||totalPages===0?'disabled':''} onclick="changeTransPage(1)">Next</button>`;
},

renderStockHistory() {
const tbody = document.querySelector('#stock-history-table tbody'); tbody.innerHTML='';
let filtered = [...this.stockPurchases];

const dStart = document.getElementById('stockFilterStart').value;
const dEnd = document.getElementById('stockFilterEnd').value;
const pCode = document.getElementById('stockFilterProduct').value;

if (dStart) filtered = filtered.filter(t => t.date >= dStart);
if (dEnd) filtered = filtered.filter(t => t.date <= dEnd);
if (pCode) filtered = filtered.filter(t => t.productCode === pCode);

filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

const totalPages = Math.ceil(filtered.length / STOCK_PER_PAGE);
if (currentStockPage > totalPages && totalPages > 0) currentStockPage = totalPages;
const start = (currentStockPage - 1) * STOCK_PER_PAGE;
const pageData = filtered.slice(start, start + STOCK_PER_PAGE);

if(pageData.length===0) {
tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#9ca3af; padding:24px;">Belum ada pembelian stok</td></tr>';
} else {
pageData.forEach((t, idx) => {
const p = this.products.find(x=>x.code===t.productCode);
tbody.innerHTML += `<tr><td>${start+idx+1}</td><td>${t.purchaseId}</td><td>${t.date}</td>
<td>${p?.name||'Unknown'}</td><td class="text-right">${t.qty}</td>
<td class="text-right font-mono" style="color:var(--color-primary); font-weight:700;">${t.totalPoints.toFixed(2)}</td>
<td class="no-print">
<button class="btn btn-small btn-secondary" onclick="openEditStockPurchase('${t.id}')">‚úèÔ∏è</button>
<button class="btn btn-small btn-danger" onclick="deleteStockPurchase('${t.id}')">üóëÔ∏è</button>
</td></tr>`;
});
}
const pag = document.getElementById('stock-pagination');
pag.innerHTML = `<span>Hal ${currentStockPage} dari ${totalPages||1}</span>
<button ${currentStockPage===1?'disabled':''} onclick="changeStockPage(-1)">Prev</button>
<button ${currentStockPage===totalPages||totalPages===0?'disabled':''} onclick="changeStockPage(1)">Next</button>`;
},

calculateMemberPoints: function() {
const mp = {};
this.members.forEach(m => mp[m.id] = { l0:0,l1:0,l2:0,l3:0,l4:0,l5:0, total:0 });
this.transactions.forEach(t => {
const p = this.products.find(x=>x.code===t.productCode); if(!p) return;
const m = this.members.find(x=>x.id===t.memberId); if(!m) return;
const total = p.point * t.qty;
const config = p.name==='Pendan Wulung' ? this.POINT_CONFIG['Pendan Wulung'] : this.POINT_CONFIG['DEFAULT'];
let mid = t.memberId, lvl=0;
while(mid && lvl<config.count) {
const pts = total * config.levels[lvl];
if(mp[mid]) { mp[mid][`l${lvl}`] += pts; mp[mid].total += pts; }
const up = this.members.find(x=>x.id===mid);
mid = up ? up.upline : null; lvl++;
}
});
Object.keys(mp).forEach(mid => {
const m = this.members.find(x=>x.id===mid);
if(m) m.totalPoints = mp[mid].total;
});
return mp;
},

renderPoints() {
const mp = this.calculateMemberPoints();
const tbody = document.querySelector('#points-table tbody'); tbody.innerHTML='';

const searchTerm = document.getElementById('pointsSearch').value.toLowerCase();
const filteredMembers = this.members.filter(m => m.name.toLowerCase().includes(searchTerm));

const totalPages = Math.ceil(filteredMembers.length / POINTS_PER_PAGE);
if (currentPointsPage > totalPages && totalPages > 0) currentPointsPage = totalPages;
const start = (currentPointsPage - 1) * POINTS_PER_PAGE;
const pageData = filteredMembers.slice(start, start + POINTS_PER_PAGE);

if(pageData.length===0) {
tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#9ca3af; padding:24px;">Data tidak ditemukan</td></tr>';
} else {
pageData.forEach(m => {
const data = mp[m.id] || {l0:0,l1:0,l2:0,l3:0,l4:0,l5:0,total:0};
tbody.innerHTML += `<tr><td>${m.name}<br><small style="color:#9ca3af">${m.id}</small></td>
<td class="font-mono">${data.l0.toFixed(2)}</td>
<td class="font-mono">${data.l1.toFixed(2)}</td>
<td class="font-mono">${data.l2.toFixed(2)}</td>
<td class="font-mono">${data.l3.toFixed(2)}</td>
<td class="font-mono">${data.l4.toFixed(2)}</td>
<td class="font-mono">${data.l5.toFixed(2)}</td>
<td class="text-right font-mono" style="font-weight:700;color:var(--color-primary)">${data.total.toFixed(2)}</td>
</tr>`;
});
}

const pag = document.getElementById('points-pagination');
pag.innerHTML = `<span>Hal ${currentPointsPage} dari ${totalPages||1}</span>
<button ${currentPointsPage===1?'disabled':''} onclick="changePointsPage(-1)">Prev</button>
<button ${currentPointsPage===totalPages||totalPages===0?'disabled':''} onclick="changePointsPage(1)">Next</button>`;
},

renderReports() {
const dStartOv = document.getElementById('repFilterStart').value;
const dEndOv = document.getElementById('repFilterEnd').value;
let txsOv = [...this.transactions];
if(dStartOv) txsOv = txsOv.filter(t => t.date >= dStartOv);
if(dEndOv) txsOv = txsOv.filter(t => t.date <= dEndOv);

const tbody = document.querySelector('#report-table tbody'); tbody.innerHTML='';
let sumBeli=0, sumPointBeli=0, sumJual=0, sumPointJual=0;
this.products.forEach(p => {
const beli = parseInt(p.pembelian||0);
const jual = txsOv.filter(t=>t.productCode===p.code).reduce((a,b)=>a+b.qty,0);
const pb = beli * p.point;
const pj = jual * p.point;
sumBeli+=beli; sumPointBeli+=pb; sumJual+=jual; sumPointJual+=pj;
if(beli>0 || jual>0) {
tbody.innerHTML += `<tr><td>${p.name}</td><td>${p.point}</td>
<td class="text-right">${beli}</td><td class="text-right">${pb.toFixed(2)}</td>
<td class="text-right">${jual}</td><td class="text-right">${pj.toFixed(2)}</td></tr>`;
}
});
document.getElementById('report-sum-beli').textContent = sumBeli;
document.getElementById('report-sum-point-beli').textContent = sumPointBeli.toFixed(2);
document.getElementById('report-sum-jual').textContent = sumJual;
document.getElementById('report-sum-point-jual').textContent = sumPointJual.toFixed(2);

const rankBody = document.querySelector('#ranking-table tbody'); rankBody.innerHTML='';
const sorted = [...this.members].sort((a,b)=>b.totalPoints - a.totalPoints);
sorted.forEach((m, i) => { rankBody.innerHTML += `<tr><td>#${i+1}</td><td>${m.id}</td><td>${m.name}</td><td class="text-right">${m.totalPoints.toFixed(2)}</td><td>${m.upline||'-'}</td></tr>`; });
},

updateModals() {
const cartContainer = document.getElementById('cart-container');
if(cartContainer.children.length === 0) addTransactionRow();
}
};

function saveProfile(e) {
e.preventDefault();
const newProfile = {
namaKoordinat: document.getElementById('profileNamaKoordinat').value,
kodeKoordinat: document.getElementById('profileKodeKoordinat').value,
namaStokis: document.getElementById('profileNamaStokis').value,
waNumber: document.getElementById('profileWaNumber').value,
alamatStokis: document.getElementById('profileAlamat').value,
waAutoMsg: app.profile ? (app.profile.waAutoMsg || DEFAULT_PROFILE.waAutoMsg) : DEFAULT_PROFILE.waAutoMsg
};
app.profile = newProfile;
app.saveData();
showToast('Profil berhasil disimpan');
}

async function checkLogin(e) {
e.preventDefault();
const u = document.getElementById('loginUsername').value.trim();
const p = document.getElementById('loginPassword').value;

if(!u || !p) return showToast('Isi username dan password', 'error');

currentUser = u;
const data = await window.loadUserDataFromFirestore(u);
if (data) {
app.products = data.products || [];
app.members = data.members || [];
app.transactions = data.transactions || [];
app.stockPurchases = data.stockPurchases || [];
app.profile = data.profile || null;
showToast(`Selamat datang, ${u}`);
} else {
app.loadSampleData();
app.profile = null;
showToast('Akun baru. Data sampel dimuat.');
}

document.getElementById('login-screen').style.display = 'none';
document.getElementById('register-screen').style.display = 'none';
document.querySelector('.container').style.display = 'grid';
app.init();
}

async function handleRegister(e) {
e.preventDefault();
const u = document.getElementById('regUsername').value;
if(!u) return;
currentUser = u;
app.loadSampleData();
app.profile = null;
app.saveData();
toggleScreen('login');
showToast('Registrasi berhasil. Silakan login.');
}

function doLogout() {
if(confirm('Yakin ingin keluar?')) {
currentUser = null;
app.products = []; app.members = []; app.transactions = []; app.stockPurchases = []; app.profile = null;
document.querySelector('.container').style.display = 'none';
document.getElementById('login-screen').style.display = 'flex';
document.getElementById('loginUsername').value = '';
document.getElementById('loginPassword').value = '';
}
}

function toggleScreen(screen) {
document.getElementById('login-screen').style.display = screen === 'login' ? 'flex' : 'none';
document.getElementById('register-screen').style.display = screen === 'register' ? 'flex' : 'none';
}

function toggleSidebar() {
document.getElementById('sidebar').classList.toggle('active');
}
function closeSidebarMobile() {
if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
}

function openAddProductModal() { 
document.getElementById('productCode').value=''; 
document.getElementById('productName').value=''; 
document.getElementById('productPoint').value=''; 
document.getElementById('productInitStock').value = '0'; 
document.getElementById('groupInitStock').style.display = 'block'; 
document.getElementById('productModal').classList.add('active'); 
}
function openEditProductModal(code) {
const p = app.products.find(x=>x.code===code);
document.getElementById('productCode').value=p.code;
document.getElementById('productName').value=p.name;
document.getElementById('productPoint').value=p.point;
document.getElementById('groupInitStock').style.display = 'none';
document.getElementById('productModal').classList.add('active');
}
function saveProduct(e) {
e.preventDefault();
const code = document.getElementById('productCode').value;
const name = document.getElementById('productName').value;
const point = parseFloat(document.getElementById('productPoint').value);
const initStock = parseInt(document.getElementById('productInitStock').value || 0);

if(code) {
const p = app.products.find(x=>x.code===code); 
p.name=name; p.point=point;
} else {
app.products.push({ code:'PROD_'+Date.now(), name, point, pembelian: initStock });
}
closeModal('productModal'); app.render(); app.saveData(); showToast('Produk disimpan');
}
app.deleteProduct = function(code) { 
if(confirm('Hapus produk?')) { 
app.products = app.products.filter(x=>x.code!==code); 
app.render(); app.saveData(); 
} 
};

function openAddMemberModal() {
document.getElementById('memberEditMode').value='false';
document.getElementById('memberOriginalId').value='';
document.getElementById('memberId').value='';
document.getElementById('memberId').disabled = false;
document.getElementById('memberName').value='';
document.getElementById('memberUpline').value='';
document.getElementById('memberKoordinat').value='';
document.getElementById('memberWaNumber').value='';
document.getElementById('memberStatus').value='aktif';
document.getElementById('memberModal').classList.add('active');
app.renderMembers();
}
function editMember(id) {
const m = app.members.find(x=>x.id===id);
document.getElementById('memberEditMode').value='true';
document.getElementById('memberOriginalId').value=id;
document.getElementById('memberId').value=m.id;
document.getElementById('memberName').value=m.name;
document.getElementById('memberUpline').value=m.upline||'';
document.getElementById('memberKoordinat').value=m.koordinat||'';
document.getElementById('memberWaNumber').value=m.waNumber||'';
document.getElementById('memberStatus').value=m.status;
document.getElementById('memberModal').classList.add('active');
app.renderMembers();
}
function saveMember(e) {
e.preventDefault();
const mode = document.getElementById('memberEditMode').value==='true';
const origId = document.getElementById('memberOriginalId').value;
const id = document.getElementById('memberId').value;
if(mode) {
const m = app.members.find(x=>x.id===origId);
m.id=id; m.name=document.getElementById('memberName').value;
m.upline=document.getElementById('memberUpline').value||null;
m.koordinat=document.getElementById('memberKoordinat').value;
m.waNumber=document.getElementById('memberWaNumber').value;
m.status=document.getElementById('memberStatus').value;
} else {
if(app.members.find(x=>x.id===id)) return showToast('ID Member sudah ada', 'error');
app.members.push({
id, name:document.getElementById('memberName').value,
upline:document.getElementById('memberUpline').value||null,
koordinat:document.getElementById('memberKoordinat').value,
waNumber:document.getElementById('memberWaNumber').value,
status:document.getElementById('memberStatus').value,
totalPoints:0
});
}
closeModal('memberModal'); app.render(); app.saveData(); showToast('Member disimpan');
}
function deleteMember(id) { 
if(confirm('Hapus member?')) { 
app.members = app.members.filter(x=>x.id!==id); 
app.members.forEach(m=>{if(m.upline===id) m.upline=null;}); 
app.render(); app.saveData(); 
} 
}

function openAddTransactionModal() {
editingTransaction = false;
document.getElementById('transEditId').value='';
document.getElementById('transModalTitle').innerText='Input Penjualan';
document.getElementById('transactionDate').valueAsDate = new Date();
document.getElementById('transactionMember').value='';
document.getElementById('cart-container').innerHTML = '';
addTransactionRow();
updateTransTotal();
document.getElementById('transactionModal').classList.add('active');
}
function openEditTransaction(id) {
editingTransaction = true;
const t = app.transactions.find(x=>x.id===id);
document.getElementById('transEditId').value=t.id;
document.getElementById('transactionDate').value=t.date;
document.getElementById('transactionMember').value=t.memberId;
document.getElementById('cart-container').innerHTML = '';
addTransactionRow(t.productCode, t.qty);
updateTransTotal();
document.getElementById('transactionModal').classList.add('active');
}
function addTransactionRow(prodCode='', qty=1) {
const div = document.createElement('div');
div.className = 'cart-row';
let opts = '<option value="">-- Pilih Produk --</option>';
app.products.forEach(p => {
const text = `${p.name} (Stok: ${p.pembelian}, Poin: ${p.point})`;
const selected = p.code === prodCode ? 'selected' : '';
opts += `<option value="${p.code}" ${selected}>${text}</option>`;
});
div.innerHTML = `
<select class="prod-select" onchange="updateTransTotal()">${opts}</select>
<input type="number" class="qty-input" value="${qty}" min="1" oninput="updateTransTotal()">
<button class="btn btn-small btn-danger" onclick="this.parentElement.remove(); updateTransTotal()">√ó</button>
`;
document.getElementById('cart-container').appendChild(div);
}
function updateTransTotal() {
let total=0;
document.querySelectorAll('.cart-row').forEach(r=>{
const c = r.querySelector('.prod-select').value;
const q = parseInt(r.querySelector('.qty-input').value)||0;
if(c) total += (app.products.find(p=>p.code===c)?.point||0) * q;
});
document.getElementById('transactionTotalPointsPreview').innerText = total.toFixed(2);
}
function saveTransaction(e) {
e.preventDefault();
const rows = document.querySelectorAll('.cart-row');
if(rows.length === 0) return showToast('Pilih produk minimal satu', 'error');
const date = document.getElementById('transactionDate').value;
const member = document.getElementById('transactionMember').value;
if(!member) return showToast('Pilih member', 'error');

const editId = document.getElementById('transEditId').value;
let oldTrx = null;

if(editId) {
oldTrx = app.transactions.find(x => x.id === editId);
if (oldTrx) {
const oldProd = app.products.find(p => p.code === oldTrx.productCode);
if (oldProd) oldProd.pembelian += oldTrx.qty;
}
app.transactions = app.transactions.filter(x=>x.id !== editId);
}

const requestMap = {};
rows.forEach(r => {
const pCode = r.querySelector('.prod-select').value;
const qty = parseInt(r.querySelector('.qty-input').value) || 0;
if(!pCode) return;
if(!requestMap[pCode]) requestMap[pCode] = 0;
requestMap[pCode] += qty;
});

for (const [pCode, reqQty] of Object.entries(requestMap)) {
const product = app.products.find(p => p.code === pCode);
if (!product) return showToast('Produk tidak ditemukan', 'error');
const availableStock = parseInt(product.pembelian || 0);
if (reqQty > availableStock) {
showToast(`Stok tidak cukup untuk ${product.name}. Tersedia: ${availableStock}, Diminta: ${reqQty}`, 'error');
return;
}
}

rows.forEach(r => {
const pCode = r.querySelector('.prod-select').value;
const qty = parseInt(r.querySelector('.qty-input').value);
if(!pCode) return;
const p = app.products.find(x=>x.code===pCode);
if(p) p.pembelian -= qty;
app.transactions.push({
id: editId || 'TRX_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),
trxId: (oldTrx && editId) ? oldTrx.trxId : 'TRX-'+new Date().toISOString().slice(0,10).replace(/-/g,'')+'-'+Math.floor(Math.random()*1000),
date, memberId:member, productCode:pCode, qty,
totalPoints: (p.point*qty)
});
});

closeModal('transactionModal'); app.render(); app.saveData(); showToast('Transaksi disimpan');
}
function deleteTransaction(id) { 
if(confirm('Hapus transaksi?')) {
const t = app.transactions.find(x=>x.id===id);
if(t) {
const p = app.products.find(x=>x.code===t.productCode);
if(p) p.pembelian += t.qty;
}
app.transactions = app.transactions.filter(x=>x.id!==id);
app.render(); app.saveData();
}
}

function openStockPurchaseModal() {
document.getElementById('stockEditId').value = '';
document.getElementById('stockModalTitle').innerText = 'üì• Input Pembelian Stokis';
document.getElementById('purchaseDate').valueAsDate = new Date();
document.getElementById('purchaseProduct').value = '';
document.getElementById('purchaseQty').value = '';
document.getElementById('stockPurchaseModal').classList.add('active');
}

function openEditStockPurchase(id) {
const purchase = app.stockPurchases.find(x => x.id === id);
if (!purchase) return;
document.getElementById('stockEditId').value = purchase.id;
document.getElementById('stockModalTitle').innerText = '‚úèÔ∏è Edit Pembelian Stokis';
document.getElementById('purchaseDate').value = purchase.date;
document.getElementById('purchaseProduct').value = purchase.productCode;
document.getElementById('purchaseQty').value = purchase.qty;
document.getElementById('stockPurchaseModal').classList.add('active');
}

function saveStockPurchase(e) {
e.preventDefault();
const editId = document.getElementById('stockEditId').value;
const date = document.getElementById('purchaseDate').value;
const productCode = document.getElementById('purchaseProduct').value;
const qty = parseInt(document.getElementById('purchaseQty').value);

if (!productCode || qty <= 0) {
showToast('Data tidak valid', 'error');
return;
}

const product = app.products.find(p => p.code === productCode);
if (!product) return showToast('Produk tidak ditemukan', 'error');

if (editId) {
const oldPurchase = app.stockPurchases.find(x => x.id === editId);
if (oldPurchase) {
if (oldPurchase.productCode === productCode) {
product.pembelian -= oldPurchase.qty;
} else {
const oldProd = app.products.find(p => p.code === oldPurchase.productCode);
if (oldProd) oldProd.pembelian -= oldPurchase.qty;
}
oldPurchase.date = date;
oldPurchase.productCode = productCode;
oldPurchase.qty = qty;
oldPurchase.totalPoints = product.point * qty;
product.pembelian += qty;
}
showToast('Pembelian Stok Berhasil Diperbarui');
} else {
const newPurchase = {
id: 'PUR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
purchaseId: 'STK-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + Math.floor(Math.random()*1000),
date: date,
productCode: productCode,
qty: qty,
totalPoints: product.point * qty
};
app.stockPurchases.push(newPurchase);
product.pembelian += qty;
showToast('Pembelian Stok Berhasil Disimpan');
}

closeModal('stockPurchaseModal');
app.render();
app.saveData();
}

function deleteStockPurchase(id) {
if(confirm('Hapus riwayat pembelian ini? Stok akan dikurangi kembali.')) {
const purchase = app.stockPurchases.find(x => x.id === id);
if (purchase) {
const product = app.products.find(p => p.code === purchase.productCode);
if (product) {
product.pembelian -= purchase.qty;
}
app.stockPurchases = app.stockPurchases.filter(x => x.id !== id);
app.render();
app.saveData();
showToast('Riwayat pembelian dihapus');
}
}
}

function applyStockFilter() {
currentStockPage = 1;
app.renderStockHistory();
}

function resetStockFilter() {
document.getElementById('stockFilterStart').value = '';
document.getElementById('stockFilterEnd').value = '';
document.getElementById('stockFilterProduct').value = '';
applyStockFilter();
}

function changeStockPage(delta) {
currentStockPage += delta;
app.renderStockHistory();
}

function searchPoints() {
currentPointsPage = 1;
app.renderPoints();
}
function changePointsPage(delta) {
currentPointsPage += delta;
app.renderPoints();
}
function toggleReportSection(id) {
document.querySelectorAll('.report-accordion').forEach(el => {
if(el.id === 'acc-'+id) el.classList.add('active');
else el.classList.remove('active');
});
if(id==='overview') app.renderReports();
if(id==='memberprod') renderReportMemberProduk();
if(id==='prodmember') renderReportProdMember();
if(id==='ranking') app.renderReports();
}
function printReport(type) {
document.body.classList.add(`printing-report-${type}`);
window.print();
setTimeout(() => document.body.classList.remove(`printing-report-${type}`), 1000);
}
function applyTransactionFilter() { currentTransPage=1; app.renderTransactions(); }
function resetTransactionFilter() { document.getElementById('filterDateStart').value=''; document.getElementById('filterDateEnd').value=''; app.renderTransactions(); }
function changeTransPage(delta) { currentTransPage+=delta; app.renderTransactions(); }

function renderReportMemberProduk() {
const pCode = document.getElementById('report-product-select').value;
const tbody = document.querySelector('#member-product-table tbody'); tbody.innerHTML='';
let filter = app.transactions;

const dStart = document.getElementById('repMemProdStart').value;
const dEnd = document.getElementById('repMemProdEnd').value;
if(dStart) filter = filter.filter(t => t.date >= dStart);
if(dEnd) filter = filter.filter(t => t.date <= dEnd);

if(pCode) filter = filter.filter(t=>t.productCode===pCode);
filter.forEach(t=>{
const m=app.members.find(x=>x.id===t.memberId); const p=app.products.find(x=>x.code===t.productCode);
tbody.innerHTML+=`<tr><td>${m?.name||'-'}</td><td>${p?.name||'-'}</td><td class="text-right">${t.qty}</td><td class="text-right">${t.totalPoints.toFixed(2)}</td></tr>`;
});
}
function renderReportProdMember() {
const mId = document.getElementById('report-member-select').value;
const tbody = document.querySelector('#product-member-table tbody'); tbody.innerHTML='';
if(!mId) return;
let filter = app.transactions.filter(t=>t.memberId===mId);

const dStart = document.getElementById('repProdMemStart').value;
const dEnd = document.getElementById('repProdMemEnd').value;
if(dStart) filter = filter.filter(t => t.date >= dStart);
if(dEnd) filter = filter.filter(t => t.date <= dEnd);

const grouped = {};
filter.forEach(t=>{
if(!grouped[t.productCode]) grouped[t.productCode]=0;
grouped[t.productCode]+=t.qty;
});
Object.keys(grouped).forEach(pc=>{
const p=app.products.find(x=>x.code===pc);
tbody.innerHTML+=`<tr><td>${p?.name||pc}</td><td class="text-right">${grouped[pc]}</td><td class="text-right">${(grouped[pc]*p.point).toFixed(2)}</td></tr>`;
});
}

function saveWaAutoMsg() {
if(!app.profile) app.profile = {...DEFAULT_PROFILE};
app.profile.waAutoMsg = document.getElementById('profileWaAutoMsg').value;
app.saveData(); showToast('Pesan tersimpan');
}
function exportData() {
const str = JSON.stringify({products:app.products, members:app.members, transactions:app.transactions, stockPurchases: app.stockPurchases, profile:app.profile});
const blob = new Blob([str], {type:'application/json'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a'); a.href=url; a.download='backup_stokis_'+(currentUser||'data')+'.json'; a.click();
}
function importData() {
const file = document.getElementById('importFile').files[0];
if(!file) return;
const reader = new FileReader();
reader.onload = function(e) {
try {
const d = JSON.parse(e.target.result);
if(d.products) app.products = d.products;
if(d.members) app.members = d.members;
if(d.transactions) app.transactions = d.transactions;
if(d.stockPurchases) app.stockPurchases = d.stockPurchases;
if(d.profile) app.profile = d.profile;
app.render(); app.saveData(); showToast('Restore berhasil');
} catch(err) { showToast('File rusak', 'error'); }
};
reader.readAsText(file);
}
function resetData() {
if(confirm('Hapus semua data lokal? Ini tidak bisa dibatalkan.')) {
app.products=[]; app.members=[]; app.transactions=[]; app.stockPurchases=[]; app.profile=null;
app.render(); app.saveData(); showToast('Data direset');
}
}

let calcBuffer='';
function calcInput(v) { calcBuffer+=v; updateCalc(); }
function calcClear() { calcBuffer=''; updateCalc(); }
function calcDelete() { calcBuffer=calcBuffer.slice(0,-1); updateCalc(); }
function calcCalculate() { try { calcBuffer = eval(calcBuffer).toString(); } catch { calcBuffer='Error'; } updateCalc(); }
function updateCalc() { document.getElementById('calcDisplay').innerText = calcBuffer || '0'; }

function closeModal(id) { document.getElementById(id).classList.remove('active'); }
window.onclick = function(e) { if(e.target.classList.contains('modal')) e.target.classList.remove('active'); }

function openBroadcastModal() { document.getElementById('broadcastMessage').value=''; document.getElementById('broadcastModal').classList.add('active'); }
function executeBroadcast() {
const msg = document.getElementById('broadcastMessage').value;
if(!msg) return showToast('Tulis pesan', 'error');
const members = app.members.filter(m=>m.waNumber && m.waNumber.length>5);
if(members.length===0) return showToast('Tidak ada member dengan nomor WA', 'error');
if(members.length>10 && !confirm(`Akan membuka ${members.length} tab browser. Lanjutkan?`)) return;

alert('Mohon IZINKAN POP-UP di browser Anda agar pesan WhatsApp terbuka otomatis.');

members.forEach((m, index) => {
setTimeout(() => {
const url = `https://wa.me/${m.waNumber}?text=${encodeURIComponent(msg)}`;
window.open(url, '_blank');
}, index * 500);
});
closeModal('broadcastModal');
}

window.app = app;
</script>
</body>
</html>